import numpy as np

def compute_embedding_distribution(embeddings, eps=1e-6):
    """
    Compute empirical mean and covariance of embeddings.

    Args:
        embeddings: numpy array of shape (m, d)
        eps: small value added to diagonal for numerical stability

    Returns:
        mu: (d,)
        sigma: (d, d)
    """

    if embeddings.ndim != 2:
        raise ValueError("embeddings must be shape (m, d)")

    m = embeddings.shape[0]

    # μ = 1/m Σ z_i
    mu = embeddings.mean(axis=0)

    # Σ = 1/m Σ (z_i - μ)(z_i - μ)^T
    centered = embeddings - mu
    sigma = centered.T @ centered / m

    # 防止协方差奇异（非常重要，后面要做log-likelihood）
    sigma += eps * np.eye(sigma.shape[0])

    return mu, sigma
